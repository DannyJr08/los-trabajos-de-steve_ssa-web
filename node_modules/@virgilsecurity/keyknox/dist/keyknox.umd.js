!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("virgil-sdk")):"function"==typeof define&&define.amd?define(["exports","virgil-sdk"],t):t((e=e||self).Keyknox={},e.Virgil)}(this,(function(e,t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function r(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var i=0;for(n=Object.getOwnPropertySymbols(e);i<n.length;i++)t.indexOf(n[i])<0&&Object.prototype.propertyIsEnumerable.call(e,n[i])&&(r[n[i]]=e[n[i]])}return r}function n(e,t,r,n){return new(r||(r=Promise))((function(i,o){function s(e){try{c(n.next(e))}catch(e){o(e)}}function a(e){try{c(n.throw(e))}catch(e){o(e)}}function c(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((n=n.apply(e,t||[])).next())}))}var i=function(e,t){return function(){for(var r=new Array(arguments.length),n=0;n<r.length;n++)r[n]=arguments[n];return e.apply(t,r)}},o=Object.prototype.toString;function s(e){return"[object Array]"===o.call(e)}function a(e){return void 0===e}function c(e){return null!==e&&"object"==typeof e}function u(e){if("[object Object]"!==o.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function d(e){return"[object Function]"===o.call(e)}function y(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),s(e))for(var r=0,n=e.length;r<n;r++)t.call(null,e[r],r,e);else for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&t.call(null,e[i],i,e)}var h={isArray:s,isArrayBuffer:function(e){return"[object ArrayBuffer]"===o.call(e)},isBuffer:function(e){return null!==e&&!a(e)&&null!==e.constructor&&!a(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:c,isPlainObject:u,isUndefined:a,isDate:function(e){return"[object Date]"===o.call(e)},isFile:function(e){return"[object File]"===o.call(e)},isBlob:function(e){return"[object Blob]"===o.call(e)},isFunction:d,isStream:function(e){return c(e)&&d(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:y,merge:function e(){var t={};function r(r,n){u(t[n])&&u(r)?t[n]=e(t[n],r):u(r)?t[n]=e({},r):s(r)?t[n]=r.slice():t[n]=r}for(var n=0,i=arguments.length;n<i;n++)y(arguments[n],r);return t},extend:function(e,t,r){return y(t,(function(t,n){e[n]=r&&"function"==typeof t?i(t,r):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e}};function l(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var p=function(e,t,r){if(!t)return e;var n;if(r)n=r(t);else if(h.isURLSearchParams(t))n=t.toString();else{var i=[];h.forEach(t,(function(e,t){null!=e&&(h.isArray(e)?t+="[]":e=[e],h.forEach(e,(function(e){h.isDate(e)?e=e.toISOString():h.isObject(e)&&(e=JSON.stringify(e)),i.push(l(t)+"="+l(e))})))})),n=i.join("&")}if(n){var o=e.indexOf("#");-1!==o&&(e=e.slice(0,o)),e+=(-1===e.indexOf("?")?"?":"&")+n}return e};function f(){this.handlers=[]}f.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},f.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},f.prototype.forEach=function(e){h.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var v=f,g=function(e,t,r){return h.forEach(r,(function(r){e=r(e,t)})),e},m=function(e){return!(!e||!e.__CANCEL__)},k=function(e,t){h.forEach(e,(function(r,n){n!==t&&n.toUpperCase()===t.toUpperCase()&&(e[t]=r,delete e[n])}))},x=function(e,t,r,n,i){return function(e,t,r,n,i){return e.config=t,r&&(e.code=r),e.request=n,e.response=i,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,r,n,i)},E=h.isStandardBrowserEnv()?{write:function(e,t,r,n,i,o){var s=[];s.push(e+"="+encodeURIComponent(t)),h.isNumber(r)&&s.push("expires="+new Date(r).toGMTString()),h.isString(n)&&s.push("path="+n),h.isString(i)&&s.push("domain="+i),!0===o&&s.push("secure"),document.cookie=s.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},K=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],w=h.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),r=document.createElement("a");function n(e){var n=e;return t&&(r.setAttribute("href",n),n=r.href),r.setAttribute("href",n),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:"/"===r.pathname.charAt(0)?r.pathname:"/"+r.pathname}}return e=n(window.location.href),function(t){var r=h.isString(t)?n(t):t;return r.protocol===e.protocol&&r.host===e.host}}():function(){return!0},b=function(e){return new Promise((function(t,r){var n=e.data,i=e.headers;h.isFormData(n)&&delete i["Content-Type"];var o=new XMLHttpRequest;if(e.auth){var s=e.auth.username||"",a=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";i.Authorization="Basic "+btoa(s+":"+a)}var c,u,d=(c=e.baseURL,u=e.url,c&&!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(u)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(c,u):u);if(o.open(e.method.toUpperCase(),p(d,e.params,e.paramsSerializer),!0),o.timeout=e.timeout,o.onreadystatechange=function(){if(o&&4===o.readyState&&(0!==o.status||o.responseURL&&0===o.responseURL.indexOf("file:"))){var n,i,s,a,c,u="getAllResponseHeaders"in o?(n=o.getAllResponseHeaders(),c={},n?(h.forEach(n.split("\n"),(function(e){if(a=e.indexOf(":"),i=h.trim(e.substr(0,a)).toLowerCase(),s=h.trim(e.substr(a+1)),i){if(c[i]&&K.indexOf(i)>=0)return;c[i]="set-cookie"===i?(c[i]?c[i]:[]).concat([s]):c[i]?c[i]+", "+s:s}})),c):c):null,d={data:e.responseType&&"text"!==e.responseType?o.response:o.responseText,status:o.status,statusText:o.statusText,headers:u,config:e,request:o};!function(e,t,r){var n=r.config.validateStatus;r.status&&n&&!n(r.status)?t(x("Request failed with status code "+r.status,r.config,null,r.request,r)):e(r)}(t,r,d),o=null}},o.onabort=function(){o&&(r(x("Request aborted",e,"ECONNABORTED",o)),o=null)},o.onerror=function(){r(x("Network Error",e,null,o)),o=null},o.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),r(x(t,e,"ECONNABORTED",o)),o=null},h.isStandardBrowserEnv()){var y=(e.withCredentials||w(d))&&e.xsrfCookieName?E.read(e.xsrfCookieName):void 0;y&&(i[e.xsrfHeaderName]=y)}if("setRequestHeader"in o&&h.forEach(i,(function(e,t){void 0===n&&"content-type"===t.toLowerCase()?delete i[t]:o.setRequestHeader(t,e)})),h.isUndefined(e.withCredentials)||(o.withCredentials=!!e.withCredentials),e.responseType)try{o.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&o.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&o.upload&&o.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){o&&(o.abort(),r(e),o=null)})),n||(n=null),o.send(n)}))},C={"Content-Type":"application/x-www-form-urlencoded"};function S(e,t){!h.isUndefined(e)&&h.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var P,A={adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(P=b),P),transformRequest:[function(e,t){return k(t,"Accept"),k(t,"Content-Type"),h.isFormData(e)||h.isArrayBuffer(e)||h.isBuffer(e)||h.isStream(e)||h.isFile(e)||h.isBlob(e)?e:h.isArrayBufferView(e)?e.buffer:h.isURLSearchParams(e)?(S(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):h.isObject(e)?(S(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(e){return e>=200&&e<300}};A.headers={common:{Accept:"application/json, text/plain, */*"}},h.forEach(["delete","get","head"],(function(e){A.headers[e]={}})),h.forEach(["post","put","patch"],(function(e){A.headers[e]=h.merge(C)}));var O=A;function T(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var R=function(e){return T(e),e.headers=e.headers||{},e.data=g(e.data,e.headers,e.transformRequest),e.headers=h.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),h.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||O.adapter)(e).then((function(t){return T(e),t.data=g(t.data,t.headers,e.transformResponse),t}),(function(t){return m(t)||(T(e),t&&t.response&&(t.response.data=g(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},j=function(e,t){t=t||{};var r={},n=["url","method","data"],i=["headers","auth","proxy","params"],o=["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","timeoutMessage","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","decompress","maxContentLength","maxBodyLength","maxRedirects","transport","httpAgent","httpsAgent","cancelToken","socketPath","responseEncoding"],s=["validateStatus"];function a(e,t){return h.isPlainObject(e)&&h.isPlainObject(t)?h.merge(e,t):h.isPlainObject(t)?h.merge({},t):h.isArray(t)?t.slice():t}function c(n){h.isUndefined(t[n])?h.isUndefined(e[n])||(r[n]=a(void 0,e[n])):r[n]=a(e[n],t[n])}h.forEach(n,(function(e){h.isUndefined(t[e])||(r[e]=a(void 0,t[e]))})),h.forEach(i,c),h.forEach(o,(function(n){h.isUndefined(t[n])?h.isUndefined(e[n])||(r[n]=a(void 0,e[n])):r[n]=a(void 0,t[n])})),h.forEach(s,(function(n){n in t?r[n]=a(e[n],t[n]):n in e&&(r[n]=a(void 0,e[n]))}));var u=n.concat(i).concat(o).concat(s),d=Object.keys(e).concat(Object.keys(t)).filter((function(e){return-1===u.indexOf(e)}));return h.forEach(d,c),r};function D(e){this.defaults=e,this.interceptors={request:new v,response:new v}}D.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=j(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[R,void 0],r=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)r=r.then(t.shift(),t.shift());return r},D.prototype.getUri=function(e){return e=j(this.defaults,e),p(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},h.forEach(["delete","get","head","options"],(function(e){D.prototype[e]=function(t,r){return this.request(j(r||{},{method:e,url:t,data:(r||{}).data}))}})),h.forEach(["post","put","patch"],(function(e){D.prototype[e]=function(t,r,n){return this.request(j(n||{},{method:e,url:t,data:r}))}}));var N=D;function U(e){this.message=e}U.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},U.prototype.__CANCEL__=!0;var M=U;function I(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var r=this;e((function(e){r.reason||(r.reason=new M(e),t(r.reason))}))}I.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},I.source=function(){var e;return{token:new I((function(t){e=t})),cancel:e}};var V=I;function H(e){var t=new N(e),r=i(N.prototype.request,t);return h.extend(r,N.prototype,t),h.extend(r,t),r}var B=H(O);B.Axios=N,B.create=function(e){return H(j(B.defaults,e))},B.Cancel=M,B.CancelToken=V,B.isCancel=m,B.all=function(e){return Promise.all(e)},B.spread=function(e){return function(t){return e.apply(null,t)}},B.isAxiosError=function(e){return"object"==typeof e&&!0===e.isAxiosError};var L=B,W=B;L.default=W;var _=L;class q extends Error{constructor(e,t="KeyknoxError",r=q){super(e),Object.setPrototypeOf(this,r.prototype),this.name=t}}class F extends q{constructor(e,t,r){super(e,"KeyknoxClientError",F),this.status=t,this.code=r}}class G extends q{constructor(){super("CloudKeyStorage is out of sync","CloudKeyStorageOutOfSyncError",G)}}class $ extends q{constructor(e){super(`Cloud entry '${e}' already exists`,"CloudEntryExistsError",$),this.cloudEntryName=e}}class z extends q{constructor(e){super(`Cloud entry '${e}' doesn't exist`,"CloudEntryDoesntExistError",z),this.cloudEntryName=e}}class J extends q{constructor(e){super(`Key entry '${e}' already exists`,"KeyEntryExistsError",J),this.keyEntryName=e}}class X extends q{constructor(e){super(`Key entry '${e}' doesn't exist`,"KeyEntryDoesntExistError",X),this.keyEntryName=e}}class Y extends q{constructor(){super("GroupSessionMessageInfo already exist","GroupTicketAlreadyExistsError",Y)}}class Z extends q{constructor(){super("Group ticket doesn't exist","GroupTicketDoesntExistError",Z)}}class Q extends q{constructor(){super("Current user has no access to the group ticket","GroupTicketNoAccessError",Q)}}class ee{constructor(e,r,n,i){this.accessTokenProvider=e,this.axios=n||_.create({baseURL:r||ee.API_URL}),this.virgilAgent=i||new t.VirgilAgent("keyknox","1.0.3"),this.axios.interceptors.response.use(void 0,ee.responseErrorHandler)}v1Push(e,t,r){return n(this,void 0,void 0,(function*(){const n={meta:e,value:t},i=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"put"}),o={headers:ee.getHeaders({accessToken:i,keyknoxHash:r,virgilAgent:this.virgilAgent})},s=yield this.axios.put("/keyknox/v1",n,o);return ee.getKeyknoxValueV1(s)}))}v1Pull(){return n(this,void 0,void 0,(function*(){const e=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"get"}),t={headers:ee.getHeaders({accessToken:e,virgilAgent:this.virgilAgent})},r=yield this.axios.get("/keyknox/v1",t);return ee.getKeyknoxValueV1(r)}))}v1Reset(){return n(this,void 0,void 0,(function*(){const e=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"delete"}),t={headers:ee.getHeaders({accessToken:e,virgilAgent:this.virgilAgent})},r=yield this.axios.post("/keyknox/v1/reset",void 0,t);return ee.getKeyknoxValueV1(r)}))}v2Push(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,key:n,identities:i,meta:o,value:s,keyknoxHash:a}=e,c={root:t,path:r,key:n,identities:i,meta:o,value:s},u=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"put"}),d={headers:ee.getHeaders({accessToken:u,keyknoxHash:a,virgilAgent:this.virgilAgent})},y=yield this.axios.post("/keyknox/v2/push",c,d);return ee.getKeyknoxValueV2(y)}))}v2Pull(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,key:n,identity:i}=e,o={root:t,path:r,key:n,identity:i},s=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"get"}),a={headers:ee.getHeaders({accessToken:s,virgilAgent:this.virgilAgent})},c=yield this.axios.post("/keyknox/v2/pull",o,a);return ee.getKeyknoxValueV2(c)}))}v2GetKeys(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,identity:n}=e,i={root:t,path:r,identity:n},o=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"get"}),s={headers:ee.getHeaders({accessToken:o,virgilAgent:this.virgilAgent})};return(yield this.axios.post("/keyknox/v2/keys",i,s)).data}))}v2Reset(e){return n(this,void 0,void 0,(function*(){const{root:t,path:r,key:n,identity:i}=e,o={root:t,path:r,key:n,identity:i},s=yield this.accessTokenProvider.getToken({service:"keyknox",operation:"delete"}),a={headers:ee.getHeaders({accessToken:s,virgilAgent:this.virgilAgent})},c=yield this.axios.post("/keyknox/v2/reset",o,a);return ee.getKeyknoxValueV2(c)}))}static getKeyknoxValueV1(e){const{data:t,headers:r}=e;return{meta:t.meta,value:t.value,version:t.version,keyknoxHash:r["virgil-keyknox-hash"]}}static getKeyknoxValueV2(e){const{data:t,headers:r}=e;return{owner:t.owner,root:t.root,path:t.path,key:t.key,identities:t.identities,meta:t.meta,value:t.value,keyknoxHash:r["virgil-keyknox-hash"]}}static getHeaders(e){const{virgilAgent:t,accessToken:r,keyknoxHash:n}=e,i={"Virgil-Agent":t.value};return r&&(i.Authorization="Virgil "+r.toString()),n&&(i["Virgil-Keyknox-Previous-Hash"]=n),i}static responseErrorHandler(e){const{response:t}=e;if(t){const{data:r}=t;return r&&r.code&&r.message?Promise.reject(new F(r.message,t.status,r.code)):Promise.reject(new F(e.message,t.status))}return Promise.reject(new F(e.message))}}ee.API_URL="https://api.virgilsecurity.com";class te{constructor(e){this.crypto=e}decrypt(e,t,r,n){if(!t||!e){if(t||e)throw new TypeError("'metadata' or 'encryptedData' is empty");return t}return this.crypto.decryptThenVerifyDetached({value:t,encoding:"base64"},{value:e,encoding:"base64"},r,n).toString("base64")}encrypt(e,t,r){const{metadata:n,encryptedData:i}=this.crypto.signThenEncryptDetached({value:e,encoding:"base64"},t,r);return{metadata:n.toString("base64"),encryptedData:i.toString("base64")}}}class re{constructor(e,t){this.myKeyknoxCrypto=e,this.keyknoxClient=t}get keyknoxCrypto(){return this.myKeyknoxCrypto}static create(e,t){const r=new ee(e);return new re(t,r)}v1Push(e,t,r,i){return n(this,void 0,void 0,(function*(){const{metadata:n,encryptedData:o}=this.myKeyknoxCrypto.encrypt(e,t,r),s=yield this.keyknoxClient.v1Push(n,o,i);return this.v1Decrypt(s,t,r)}))}v1Pull(e,t){return n(this,void 0,void 0,(function*(){const r=yield this.keyknoxClient.v1Pull();return this.v1Decrypt(r,e,t)}))}v1Reset(){return n(this,void 0,void 0,(function*(){return this.keyknoxClient.v1Reset()}))}v1Update(e){return n(this,void 0,void 0,(function*(){const{value:t,privateKey:r,publicKeys:n,keyknoxHash:i,newPrivateKey:o,newPublicKeys:s}=e;if(!o&&!s)return this.v1Push(t,r,n,i);const a=yield this.v1Pull(r,n),c=o||r,u=s||n,{metadata:d,encryptedData:y}=this.myKeyknoxCrypto.encrypt(a.value,c,u),h=yield this.keyknoxClient.v1Push(d,y,a.keyknoxHash);return this.v1Decrypt(h,c,u)}))}v1UpdateRecipients(e){return n(this,void 0,void 0,(function*(){const{privateKey:t,publicKeys:r,newPrivateKey:n,newPublicKeys:i}=e,o=yield this.v1Pull(t,r);if(!o.meta&&!o.value)return o;const s=n||t,a=i||r,{metadata:c,encryptedData:u}=this.myKeyknoxCrypto.encrypt(o.value,s,a),d=yield this.keyknoxClient.v1Push(c,u,o.keyknoxHash);return this.v1Decrypt(d,s,a)}))}v2Push(e){return n(this,void 0,void 0,(function*(){const{value:t,privateKey:n,publicKeys:i}=e,o=r(e,["value","privateKey","publicKeys"]),{metadata:s,encryptedData:a}=this.encrypt(t,n,i),c=yield this.keyknoxClient.v2Push(Object.assign(Object.assign({},o),{value:a,meta:s}));return this.v2Decrypt(c,n,i)}))}v2Pull(e){return n(this,void 0,void 0,(function*(){const{privateKey:t,publicKeys:n}=e,i=r(e,["privateKey","publicKeys"]),o=yield this.keyknoxClient.v2Pull(i);return this.v2Decrypt(o,t,n)}))}v2GetKeys(e){return n(this,void 0,void 0,(function*(){return this.keyknoxClient.v2GetKeys(e)}))}v2Reset(e){return n(this,void 0,void 0,(function*(){return this.keyknoxClient.v2Reset(e)}))}v1Decrypt(e,t,n){const{meta:i,value:o}=e,s=r(e,["meta","value"]),a=this.myKeyknoxCrypto.decrypt(i,o,t,n);return Object.assign(Object.assign({},s),{meta:i,value:a})}v2Decrypt(e,t,n){const{meta:i,value:o}=e,s=r(e,["meta","value"]),a=this.myKeyknoxCrypto.decrypt(i,o,t,n);return Object.assign(Object.assign({},s),{meta:i,value:a})}encrypt(e,t,r){return this.myKeyknoxCrypto.encrypt(e,t,r)}}class ne{constructor(e){const{keyknoxManager:t,identity:r,privateKey:n,publicKey:i,root:o}=e;this.keyknoxManager=t,this.identity=r,this.privateKey=n,this.publicKey=i,this.root=o||ne.DEFAULT_ROOT}static create(e){const{accessTokenProvider:t,identity:r,privateKey:n,publicKey:i,virgilCrypto:o,root:s}=e,a=re.create(t,new te(o));return new ne({keyknoxManager:a,identity:r,privateKey:n,publicKey:i,root:s})}store(e,t){return n(this,void 0,void 0,(function*(){const{epochNumber:r,sessionId:n,data:i}=e;let o=[this.identity],s=[this.publicKey];if(t){const e=Array.isArray(t)?t:[t];o=o.concat(e.map(e=>e.identity)),s=s.concat(e.map(e=>e.publicKey))}try{yield this.keyknoxManager.v2Push({identities:o,publicKeys:s,privateKey:this.privateKey,root:this.root,path:n,key:r.toString(),value:i})}catch(e){if(e instanceof F&&50010===e.code)throw new Y;throw e}}))}retrieve(e,t,r){return n(this,void 0,void 0,(function*(){let n=this.identity,i=this.publicKey;if(t&&r)n=t,i=r;else if(Boolean(t)!==Boolean(r))throw new Error("You need to provide both 'identity' and 'publicKey'");const o=yield this.keyknoxManager.v2GetKeys({root:this.root,path:e,identity:n});if(!o.length)throw new Z;const s=o.map(t=>this.keyknoxManager.v2Pull({root:this.root,path:e,key:t,identity:n,privateKey:this.privateKey,publicKeys:i}));try{const e=yield Promise.all(s);return e.map(({key:e,path:t,identities:r,value:n})=>({identities:r,groupSessionMessageInfo:{sessionId:t,epochNumber:Number(e),data:n}}))}catch(e){throw ne.throwIfRecipientIsNotFound(e),e}}))}addRecipients(e,t){return n(this,void 0,void 0,(function*(){const r=(yield this.keyknoxManager.v2GetKeys({root:this.root,path:e,identity:this.identity})).map(r=>n(this,void 0,void 0,(function*(){const n=yield this.keyknoxManager.v2Pull({root:this.root,path:e,key:r,identity:this.identity,privateKey:this.privateKey,publicKeys:this.publicKey});yield this.keyknoxManager.v2Push(Object.assign(Object.assign({},n),{identities:t.map(e=>e.identity),publicKeys:[this.publicKey,...t.map(e=>e.publicKey)],privateKey:this.privateKey}))})));try{yield Promise.all(r)}catch(e){throw ne.throwIfRecipientIsNotFound(e),e}}))}addRecipient(e,t){return n(this,void 0,void 0,(function*(){return this.addRecipients(e,[t])}))}reAddRecipient(e,t){return n(this,void 0,void 0,(function*(){const r=(yield this.keyknoxManager.v2GetKeys({root:this.root,path:e,identity:this.identity})).map(r=>n(this,void 0,void 0,(function*(){const n=yield this.keyknoxManager.v2Pull({root:this.root,path:e,key:r,identity:this.identity,privateKey:this.privateKey,publicKeys:this.publicKey});yield this.removeRecipient(e,t.identity,Number(r)),yield this.keyknoxManager.v2Push({root:this.root,path:e,key:r,identities:[t.identity],value:n.value,privateKey:this.privateKey,publicKeys:[this.publicKey,t.publicKey],keyknoxHash:n.keyknoxHash})})));try{yield Promise.all(r)}catch(e){throw ne.throwIfRecipientIsNotFound(e),e}}))}removeRecipient(e,t,r){return n(this,void 0,void 0,(function*(){yield this.keyknoxManager.v2Reset({identity:t,root:this.root,path:e,key:"number"==typeof r?r.toString():void 0})}))}delete(e){return n(this,void 0,void 0,(function*(){return this.keyknoxManager.v2Reset({root:this.root,path:e})}))}static throwIfRecipientIsNotFound(e){if("FoundationError"===e.name&&/recipient defined with id is not found/gi.test(e.message))throw new Q}}ne.DEFAULT_ROOT="group-sessions";var ie="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};var oe=function(e,t){return e(t={exports:{}},t.exports),t.exports}((function(e,t){!function(r){var n=t,i=e&&e.exports==n&&e,o="object"==typeof ie&&ie;o.global!==o&&o.window!==o||(r=o);var s=function(e){this.message=e};(s.prototype=new Error).name="InvalidCharacterError";var a=function(e){throw new s(e)},c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=/[\t\n\f\r ]/g,d={encode:function(e){e=String(e),/[^\0-\xFF]/.test(e)&&a("The string to be encoded contains characters outside of the Latin1 range.");for(var t,r,n,i,o=e.length%3,s="",u=-1,d=e.length-o;++u<d;)t=e.charCodeAt(u)<<16,r=e.charCodeAt(++u)<<8,n=e.charCodeAt(++u),s+=c.charAt((i=t+r+n)>>18&63)+c.charAt(i>>12&63)+c.charAt(i>>6&63)+c.charAt(63&i);return 2==o?(t=e.charCodeAt(u)<<8,r=e.charCodeAt(++u),s+=c.charAt((i=t+r)>>10)+c.charAt(i>>4&63)+c.charAt(i<<2&63)+"="):1==o&&(i=e.charCodeAt(u),s+=c.charAt(i>>2)+c.charAt(i<<4&63)+"=="),s},decode:function(e){var t=(e=String(e).replace(u,"")).length;t%4==0&&(t=(e=e.replace(/==?$/,"")).length),(t%4==1||/[^+a-zA-Z0-9/]/.test(e))&&a("Invalid character: the string to be decoded is not correctly encoded.");for(var r,n,i=0,o="",s=-1;++s<t;)n=c.indexOf(e.charAt(s)),r=i%4?64*r+n:n,i++%4&&(o+=String.fromCharCode(255&r>>(-2*i&6)));return o},version:"0.1.0"};if(n&&!n.nodeType)if(i)i.exports=d;else for(var y in d)d.hasOwnProperty(y)&&(n[y]=d[y]);else r.base64=d}(ie)}));function se(e){const t={};return e.forEach((e,r)=>{t[r]={data:e.data,meta:e.meta,creation_date:Number(e.creationDate),name:e.name,modification_date:Number(e.modificationDate)},null===t[r].meta&&delete t[r].meta}),oe.encode(JSON.stringify(t))}function ae(e){const t=oe.decode(e);if(!t.length)return new Map;const r=JSON.parse(t);return Object.keys(r).reduce((e,t)=>{const n=r[t];return e.set(t,{name:n.name,data:n.data,creationDate:new Date(n.creation_date),modificationDate:new Date(n.modification_date),meta:void 0===n.meta?null:n.meta}),e},new Map)}class ce{constructor(e,t,r){this.cache=new Map,this.syncWasCalled=!1,this.keyknoxManager=e,this.privateKey=t,this.publicKeys=r}static create(e){const{accessTokenProvider:t,privateKey:r,publicKeys:n,virgilCrypto:i}=e,o=re.create(t,new te(i));return new ce(o,r,n)}storeEntries(e){return n(this,void 0,void 0,(function*(){return this.throwUnlessSyncWasCalled(),e.forEach(e=>{this.throwIfCloudEntryExists(e.name),this.cache.set(e.name,ce.createCloudEntry(e))}),yield this.pushCacheEntries(),e.map(e=>this.cache.get(e.name))}))}storeEntry(e,t,r){return n(this,void 0,void 0,(function*(){if("string"==typeof r){const n=r,i=yield this.keyknoxManager.v2Pull({root:"e3kit",path:"backup",key:n,identity:e,privateKey:this.privateKey,publicKeys:this.publicKeys}),o=ce.createCloudEntry({name:n,data:t});return ae((yield this.keyknoxManager.v2Push({root:"e3kit",path:"backup",key:n,identities:[e],value:se(new Map([[n,o]])),privateKey:this.privateKey,publicKeys:this.publicKeys,keyknoxHash:i.keyknoxHash})).value).values().next().value}{const[n]=yield this.storeEntries([{name:e,data:t,meta:r}]);return n}}))}updateEntry(e,t,r){return n(this,void 0,void 0,(function*(){this.throwUnlessSyncWasCalled(),this.throwUnlessCloudEntryExists(e);const n=ce.createCloudEntry({name:e,data:t,meta:r},this.cache.get(e).creationDate);return this.cache.set(e,n),yield this.pushCacheEntries(),n}))}retrieveEntry(e){return this.throwUnlessSyncWasCalled(),this.throwUnlessCloudEntryExists(e),this.cache.get(e)}fetchEntryByKey(e,t){return n(this,void 0,void 0,(function*(){return ae((yield this.keyknoxManager.v2Pull({root:"e3kit",path:"backup",key:t,identity:e,privateKey:this.privateKey,publicKeys:this.publicKeys})).value).values().next().value}))}retrieveAllEntries(){return this.throwUnlessSyncWasCalled(),Array.from(this.cache.values())}existsEntry(e){return this.throwUnlessSyncWasCalled(),this.cache.has(e)}deleteEntry(e){return n(this,void 0,void 0,(function*(){yield this.deleteEntries([e])}))}deleteEntries(e){return n(this,void 0,void 0,(function*(){this.throwUnlessSyncWasCalled(),e.forEach(e=>{this.throwUnlessCloudEntryExists(e),this.cache.delete(e)}),yield this.pushCacheEntries()}))}deleteAllEntries(){return n(this,void 0,void 0,(function*(){this.cache.clear(),this.decryptedKeyknoxValue=yield this.keyknoxManager.v1Reset()}))}updateRecipients(e){return n(this,void 0,void 0,(function*(){this.throwUnlessSyncWasCalled();const{newPrivateKey:t,newPublicKeys:r}=e;this.decryptedKeyknoxValue=yield this.keyknoxManager.v1UpdateRecipients({newPrivateKey:t,newPublicKeys:r,privateKey:this.privateKey,publicKeys:this.publicKeys}),this.privateKey=t||this.privateKey,this.publicKeys=r||this.publicKeys,this.cache=ae(this.decryptedKeyknoxValue.value)}))}retrieveCloudEntries(){return n(this,void 0,void 0,(function*(){this.decryptedKeyknoxValue=yield this.keyknoxManager.v1Pull(this.privateKey,this.publicKeys),this.cache=ae(this.decryptedKeyknoxValue.value),this.syncWasCalled=!0}))}throwUnlessSyncWasCalled(){if(!this.syncWasCalled)throw new G}throwUnlessCloudEntryExists(e){if(!this.cache.has(e))throw new z(e)}throwIfCloudEntryExists(e){if(this.cache.has(e))throw new $(e)}pushCacheEntries(){return n(this,void 0,void 0,(function*(){const e=se(this.cache);this.decryptedKeyknoxValue=yield this.keyknoxManager.v1Push(e,this.privateKey,this.publicKeys,this.decryptedKeyknoxValue.keyknoxHash),this.cache=ae(this.decryptedKeyknoxValue.value)}))}static createCloudEntry(e,t){const r=new Date;return{name:e.name,data:e.data,meta:void 0===e.meta?null:e.meta,creationDate:t||r,modificationDate:r}}}class ue{constructor(e,t){this.formatKeyEntry=e=>Object.assign(Object.assign({},e),{name:e.name.replace(this.prefix,"")}),this.prefix=`_VIRGIL_IDENTITY=${e}.`,this.prefixRegExp=new RegExp("^"+this.prefix),this.keyEntryStorage=t}save(e){return n(this,void 0,void 0,(function*(){const t=yield this.keyEntryStorage.save(Object.assign(Object.assign({},e),{name:this.getKeyEntryName(e.name)}));return this.formatKeyEntry(t)}))}load(e){return n(this,void 0,void 0,(function*(){const t=yield this.keyEntryStorage.load(this.getKeyEntryName(e));return null===t?null:this.formatKeyEntry(t)}))}exists(e){return this.keyEntryStorage.exists(this.getKeyEntryName(e))}remove(e){return this.keyEntryStorage.remove(this.getKeyEntryName(e))}list(){return n(this,void 0,void 0,(function*(){return(yield this.getAllKeyEntries()).map(this.formatKeyEntry)}))}update(e){return n(this,void 0,void 0,(function*(){const t=yield this.keyEntryStorage.update(Object.assign(Object.assign({},e),{name:this.getKeyEntryName(e.name)}));return this.formatKeyEntry(t)}))}clear(){return n(this,void 0,void 0,(function*(){const e=yield this.getAllKeyEntries();for(const t of e)yield this.keyEntryStorage.remove(t.name)}))}getKeyEntryName(e){return`${this.prefix}${e}`}getAllKeyEntries(){return n(this,void 0,void 0,(function*(){return(yield this.keyEntryStorage.list()).filter(e=>this.prefixRegExp.test(e.name))}))}}function de(e){return{name:e.name,value:e.data,meta:Object.assign(Object.assign({},e.meta),{k_cda:e.creationDate.toISOString(),k_mda:e.modificationDate.toISOString()})}}class ye{constructor(e,t,r){this.cloudKeyStorage=t,this.keyEntryStorageWrapper=new ue(e,r)}static create(e){const{virgilCrypto:t,identity:r,accessTokenProvider:n,privateKey:i,publicKeys:o}=e,s=ce.create({accessTokenProvider:n,privateKey:i,publicKeys:o,virgilCrypto:t});return new ye(r,s,e.keyEntryStorage)}storeEntries(e){return n(this,void 0,void 0,(function*(){const t=e.map(e=>this.throwIfKeyEntryExists(e.name));yield Promise.all(t);const r=(yield this.cloudKeyStorage.storeEntries(e)).map(e=>n(this,void 0,void 0,(function*(){const t=de(e);return this.keyEntryStorageWrapper.save(t)})));return Promise.all(r)}))}storeEntry(e,t,r){return n(this,void 0,void 0,(function*(){const[n]=yield this.storeEntries([{name:e,data:t,meta:r}]);return n}))}updateEntry(e,t,r){return n(this,void 0,void 0,(function*(){yield this.throwUnlessKeyEntryExists(e);const n=de(yield this.cloudKeyStorage.updateEntry(e,t,r));yield this.keyEntryStorageWrapper.update(n)}))}retrieveEntry(e){return n(this,void 0,void 0,(function*(){return yield this.throwUnlessKeyEntryExists(e),this.keyEntryStorageWrapper.load(e)}))}retrieveAllEntries(){return this.keyEntryStorageWrapper.list()}existsEntry(e){return this.keyEntryStorageWrapper.exists(e)}deleteEntry(e){return this.deleteEntries([e])}deleteEntries(e){return n(this,void 0,void 0,(function*(){yield this.cloudKeyStorage.deleteEntries(e);const t=e.map(e=>this.keyEntryStorageWrapper.remove(e));yield Promise.all(t)}))}deleteAllEntries(){return n(this,void 0,void 0,(function*(){yield this.cloudKeyStorage.deleteAllEntries(),yield this.keyEntryStorageWrapper.clear()}))}updateRecipients(e){return n(this,void 0,void 0,(function*(){const{newPrivateKey:t,newPublicKeys:r}=e;return this.cloudKeyStorage.updateRecipients({newPrivateKey:t,newPublicKeys:r})}))}sync(){return n(this,void 0,void 0,(function*(){yield this.cloudKeyStorage.retrieveCloudEntries();const e=this.cloudKeyStorage.retrieveAllEntries(),t=e.reduce((e,t)=>(e[t.name]=t,e),{}),r=yield this.keyEntryStorageWrapper.list(),n=r.reduce((e,t)=>(e[t.name]=t,e),{}),i=[],o=[],s=[];return e.forEach(e=>{const t=n[e.name];if(t){const{modificationDate:r}=function(e){if(!e.meta)throw new TypeError("Invalid 'IKeyEntry'");return{creationDate:new Date(e.meta.k_cda),modificationDate:new Date(e.meta.k_mda)}}(t);if(e.modificationDate>r)return o.push(e.name)}else i.push(e.name)}),r.forEach(e=>{t[e.name]||s.push(e.name)}),this.syncKeyStorage(i,o,s)}))}throwUnlessKeyEntryExists(e){return n(this,void 0,void 0,(function*(){if(!(yield this.keyEntryStorageWrapper.exists(e)))throw new X(e)}))}throwIfKeyEntryExists(e){return n(this,void 0,void 0,(function*(){if(yield this.keyEntryStorageWrapper.exists(e))throw new J(e)}))}syncKeyStorage(e,t,r){return n(this,void 0,void 0,(function*(){const i=r.map(e=>n(this,void 0,void 0,(function*(){yield this.keyEntryStorageWrapper.remove(e)}))),o=t.map(e=>n(this,void 0,void 0,(function*(){const t=de(this.cloudKeyStorage.retrieveEntry(e));yield this.keyEntryStorageWrapper.update(t)}))),s=e.map(e=>n(this,void 0,void 0,(function*(){const t=de(this.cloudKeyStorage.retrieveEntry(e));yield this.keyEntryStorageWrapper.save(t)})));yield Promise.all([...i,...o,...s])}))}}e.CloudEntryDoesntExistError=z,e.CloudEntryExistsError=$,e.CloudGroupTicketStorage=ne,e.CloudKeyStorage=ce,e.CloudKeyStorageOutOfSyncError=G,e.GroupTicketAlreadyExistsError=Y,e.GroupTicketDoesntExistError=Z,e.GroupTicketNoAccessError=Q,e.KeyEntryDoesntExistError=X,e.KeyEntryExistsError=J,e.KeyknoxClient=ee,e.KeyknoxClientError=F,e.KeyknoxCrypto=te,e.KeyknoxError=q,e.KeyknoxManager=re,e.SyncKeyStorage=ye,Object.defineProperty(e,"__esModule",{value:!0})}));
