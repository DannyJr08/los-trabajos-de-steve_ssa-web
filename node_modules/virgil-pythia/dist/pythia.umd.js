!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("virgil-sdk")):"function"==typeof define&&define.amd?define(["exports","virgil-sdk"],t):t((e=e||self).VirgilPythia={},e.Virgil)}(this,(function(e,t){"use strict";
/*! *****************************************************************************
    Copyright (c) Microsoft Corporation.

    Permission to use, copy, modify, and/or distribute this software for any
    purpose with or without fee is hereby granted.

    THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
    REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
    AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
    INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
    LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
    OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
    PERFORMANCE OF THIS SOFTWARE.
    ***************************************************************************** */function r(e,t,r,o){return new(r||(r=Promise))((function(n,i){function s(e){try{c(o.next(e))}catch(e){i(e)}}function a(e){try{c(o.throw(e))}catch(e){i(e)}}function c(e){var t;e.done?n(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,a)}c((o=o.apply(e,t||[])).next())}))}class o{constructor(e){this.crypto=e.crypto,this.brainKeyCrypto=e.brainKeyCrypto,this.pythiaClient=e.pythiaClient,this.keyPairType=e.keyPairType}generateKeyPair(e,t){return r(this,void 0,void 0,(function*(){const{blindedPassword:r,blindingSecret:o}=this.brainKeyCrypto.blind(e),n=yield this.pythiaClient.generateSeed(r.toString("base64"),t),i=this.brainKeyCrypto.deblind({blindingSecret:o,transformedPassword:n});return this.crypto.generateKeysFromKeyMaterial(i,this.keyPairType)}))}}class n{constructor(e,t,r){this.salt=n.valueToString(e),this.deblindedPassword=n.valueToString(t),this.version=r}toJSON(){return{salt:this.salt,deblindedPassword:this.deblindedPassword,version:this.version}}static valueToString(e){return"string"==typeof e?e:e.toString("base64")}}var i=function(e,t){return function(){for(var r=new Array(arguments.length),o=0;o<r.length;o++)r[o]=arguments[o];return e.apply(t,r)}},s=Object.prototype.toString;function a(e){return"[object Array]"===s.call(e)}function c(e){return void 0===e}function u(e){return null!==e&&"object"==typeof e}function d(e){if("[object Object]"!==s.call(e))return!1;var t=Object.getPrototypeOf(e);return null===t||t===Object.prototype}function f(e){return"[object Function]"===s.call(e)}function p(e,t){if(null!=e)if("object"!=typeof e&&(e=[e]),a(e))for(var r=0,o=e.length;r<o;r++)t.call(null,e[r],r,e);else for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.call(null,e[n],n,e)}var l={isArray:a,isArrayBuffer:function(e){return"[object ArrayBuffer]"===s.call(e)},isBuffer:function(e){return null!==e&&!c(e)&&null!==e.constructor&&!c(e.constructor)&&"function"==typeof e.constructor.isBuffer&&e.constructor.isBuffer(e)},isFormData:function(e){return"undefined"!=typeof FormData&&e instanceof FormData},isArrayBufferView:function(e){return"undefined"!=typeof ArrayBuffer&&ArrayBuffer.isView?ArrayBuffer.isView(e):e&&e.buffer&&e.buffer instanceof ArrayBuffer},isString:function(e){return"string"==typeof e},isNumber:function(e){return"number"==typeof e},isObject:u,isPlainObject:d,isUndefined:c,isDate:function(e){return"[object Date]"===s.call(e)},isFile:function(e){return"[object File]"===s.call(e)},isBlob:function(e){return"[object Blob]"===s.call(e)},isFunction:f,isStream:function(e){return u(e)&&f(e.pipe)},isURLSearchParams:function(e){return"undefined"!=typeof URLSearchParams&&e instanceof URLSearchParams},isStandardBrowserEnv:function(){return("undefined"==typeof navigator||"ReactNative"!==navigator.product&&"NativeScript"!==navigator.product&&"NS"!==navigator.product)&&("undefined"!=typeof window&&"undefined"!=typeof document)},forEach:p,merge:function e(){var t={};function r(r,o){d(t[o])&&d(r)?t[o]=e(t[o],r):d(r)?t[o]=e({},r):a(r)?t[o]=r.slice():t[o]=r}for(var o=0,n=arguments.length;o<n;o++)p(arguments[o],r);return t},extend:function(e,t,r){return p(t,(function(t,o){e[o]=r&&"function"==typeof t?i(t,r):t})),e},trim:function(e){return e.replace(/^\s*/,"").replace(/\s*$/,"")},stripBOM:function(e){return 65279===e.charCodeAt(0)&&(e=e.slice(1)),e}};function h(e){return encodeURIComponent(e).replace(/%3A/gi,":").replace(/%24/g,"$").replace(/%2C/gi,",").replace(/%20/g,"+").replace(/%5B/gi,"[").replace(/%5D/gi,"]")}var y=function(e,t,r){if(!t)return e;var o;if(r)o=r(t);else if(l.isURLSearchParams(t))o=t.toString();else{var n=[];l.forEach(t,(function(e,t){null!=e&&(l.isArray(e)?t+="[]":e=[e],l.forEach(e,(function(e){l.isDate(e)?e=e.toISOString():l.isObject(e)&&(e=JSON.stringify(e)),n.push(h(t)+"="+h(e))})))})),o=n.join("&")}if(o){var i=e.indexOf("#");-1!==i&&(e=e.slice(0,i)),e+=(-1===e.indexOf("?")?"?":"&")+o}return e};function m(){this.handlers=[]}m.prototype.use=function(e,t){return this.handlers.push({fulfilled:e,rejected:t}),this.handlers.length-1},m.prototype.eject=function(e){this.handlers[e]&&(this.handlers[e]=null)},m.prototype.forEach=function(e){l.forEach(this.handlers,(function(t){null!==t&&e(t)}))};var v=m,g=function(e,t,r){return l.forEach(r,(function(r){e=r(e,t)})),e},w=function(e){return!(!e||!e.__CANCEL__)},b=function(e,t){l.forEach(e,(function(r,o){o!==t&&o.toUpperCase()===t.toUpperCase()&&(e[t]=r,delete e[o])}))},P=function(e,t,r,o,n){return function(e,t,r,o,n){return e.config=t,r&&(e.code=r),e.request=o,e.response=n,e.isAxiosError=!0,e.toJSON=function(){return{message:this.message,name:this.name,description:this.description,number:this.number,fileName:this.fileName,lineNumber:this.lineNumber,columnNumber:this.columnNumber,stack:this.stack,config:this.config,code:this.code}},e}(new Error(e),t,r,o,n)},C=l.isStandardBrowserEnv()?{write:function(e,t,r,o,n,i){var s=[];s.push(e+"="+encodeURIComponent(t)),l.isNumber(r)&&s.push("expires="+new Date(r).toGMTString()),l.isString(o)&&s.push("path="+o),l.isString(n)&&s.push("domain="+n),!0===i&&s.push("secure"),document.cookie=s.join("; ")},read:function(e){var t=document.cookie.match(new RegExp("(^|;\\s*)("+e+")=([^;]*)"));return t?decodeURIComponent(t[3]):null},remove:function(e){this.write(e,"",Date.now()-864e5)}}:{write:function(){},read:function(){return null},remove:function(){}},E=["age","authorization","content-length","content-type","etag","expires","from","host","if-modified-since","if-unmodified-since","last-modified","location","max-forwards","proxy-authorization","referer","retry-after","user-agent"],x=l.isStandardBrowserEnv()?function(){var e,t=/(msie|trident)/i.test(navigator.userAgent),r=document.createElement("a");function o(e){var o=e;return t&&(r.setAttribute("href",o),o=r.href),r.setAttribute("href",o),{href:r.href,protocol:r.protocol?r.protocol.replace(/:$/,""):"",host:r.host,search:r.search?r.search.replace(/^\?/,""):"",hash:r.hash?r.hash.replace(/^#/,""):"",hostname:r.hostname,port:r.port,pathname:"/"===r.pathname.charAt(0)?r.pathname:"/"+r.pathname}}return e=o(window.location.href),function(t){var r=l.isString(t)?o(t):t;return r.protocol===e.protocol&&r.host===e.host}}():function(){return!0},T=function(e){return new Promise((function(t,r){var o=e.data,n=e.headers;l.isFormData(o)&&delete n["Content-Type"];var i=new XMLHttpRequest;if(e.auth){var s=e.auth.username||"",a=e.auth.password?unescape(encodeURIComponent(e.auth.password)):"";n.Authorization="Basic "+btoa(s+":"+a)}var c,u,d=(c=e.baseURL,u=e.url,c&&!/^([a-z][a-z\d\+\-\.]*:)?\/\//i.test(u)?function(e,t){return t?e.replace(/\/+$/,"")+"/"+t.replace(/^\/+/,""):e}(c,u):u);if(i.open(e.method.toUpperCase(),y(d,e.params,e.paramsSerializer),!0),i.timeout=e.timeout,i.onreadystatechange=function(){if(i&&4===i.readyState&&(0!==i.status||i.responseURL&&0===i.responseURL.indexOf("file:"))){var o,n,s,a,c,u="getAllResponseHeaders"in i?(o=i.getAllResponseHeaders(),c={},o?(l.forEach(o.split("\n"),(function(e){if(a=e.indexOf(":"),n=l.trim(e.substr(0,a)).toLowerCase(),s=l.trim(e.substr(a+1)),n){if(c[n]&&E.indexOf(n)>=0)return;c[n]="set-cookie"===n?(c[n]?c[n]:[]).concat([s]):c[n]?c[n]+", "+s:s}})),c):c):null,d={data:e.responseType&&"text"!==e.responseType?i.response:i.responseText,status:i.status,statusText:i.statusText,headers:u,config:e,request:i};!function(e,t,r){var o=r.config.validateStatus;r.status&&o&&!o(r.status)?t(P("Request failed with status code "+r.status,r.config,null,r.request,r)):e(r)}(t,r,d),i=null}},i.onabort=function(){i&&(r(P("Request aborted",e,"ECONNABORTED",i)),i=null)},i.onerror=function(){r(P("Network Error",e,null,i)),i=null},i.ontimeout=function(){var t="timeout of "+e.timeout+"ms exceeded";e.timeoutErrorMessage&&(t=e.timeoutErrorMessage),r(P(t,e,"ECONNABORTED",i)),i=null},l.isStandardBrowserEnv()){var f=(e.withCredentials||x(d))&&e.xsrfCookieName?C.read(e.xsrfCookieName):void 0;f&&(n[e.xsrfHeaderName]=f)}if("setRequestHeader"in i&&l.forEach(n,(function(e,t){void 0===o&&"content-type"===t.toLowerCase()?delete n[t]:i.setRequestHeader(t,e)})),l.isUndefined(e.withCredentials)||(i.withCredentials=!!e.withCredentials),e.responseType)try{i.responseType=e.responseType}catch(t){if("json"!==e.responseType)throw t}"function"==typeof e.onDownloadProgress&&i.addEventListener("progress",e.onDownloadProgress),"function"==typeof e.onUploadProgress&&i.upload&&i.upload.addEventListener("progress",e.onUploadProgress),e.cancelToken&&e.cancelToken.promise.then((function(e){i&&(i.abort(),r(e),i=null)})),o||(o=null),i.send(o)}))},S={"Content-Type":"application/x-www-form-urlencoded"};function k(e,t){!l.isUndefined(e)&&l.isUndefined(e["Content-Type"])&&(e["Content-Type"]=t)}var A,U={adapter:(("undefined"!=typeof XMLHttpRequest||"undefined"!=typeof process&&"[object process]"===Object.prototype.toString.call(process))&&(A=T),A),transformRequest:[function(e,t){return b(t,"Accept"),b(t,"Content-Type"),l.isFormData(e)||l.isArrayBuffer(e)||l.isBuffer(e)||l.isStream(e)||l.isFile(e)||l.isBlob(e)?e:l.isArrayBufferView(e)?e.buffer:l.isURLSearchParams(e)?(k(t,"application/x-www-form-urlencoded;charset=utf-8"),e.toString()):l.isObject(e)?(k(t,"application/json;charset=utf-8"),JSON.stringify(e)):e}],transformResponse:[function(e){if("string"==typeof e)try{e=JSON.parse(e)}catch(e){}return e}],timeout:0,xsrfCookieName:"XSRF-TOKEN",xsrfHeaderName:"X-XSRF-TOKEN",maxContentLength:-1,maxBodyLength:-1,validateStatus:function(e){return e>=200&&e<300}};U.headers={common:{Accept:"application/json, text/plain, */*"}},l.forEach(["delete","get","head"],(function(e){U.headers[e]={}})),l.forEach(["post","put","patch"],(function(e){U.headers[e]=l.merge(S)}));var B=U;function R(e){e.cancelToken&&e.cancelToken.throwIfRequested()}var N=function(e){return R(e),e.headers=e.headers||{},e.data=g(e.data,e.headers,e.transformRequest),e.headers=l.merge(e.headers.common||{},e.headers[e.method]||{},e.headers),l.forEach(["delete","get","head","post","put","patch","common"],(function(t){delete e.headers[t]})),(e.adapter||B.adapter)(e).then((function(t){return R(e),t.data=g(t.data,t.headers,e.transformResponse),t}),(function(t){return w(t)||(R(e),t&&t.response&&(t.response.data=g(t.response.data,t.response.headers,e.transformResponse))),Promise.reject(t)}))},O=function(e,t){t=t||{};var r={},o=["url","method","data"],n=["headers","auth","proxy","params"],i=["baseURL","transformRequest","transformResponse","paramsSerializer","timeout","timeoutMessage","withCredentials","adapter","responseType","xsrfCookieName","xsrfHeaderName","onUploadProgress","onDownloadProgress","decompress","maxContentLength","maxBodyLength","maxRedirects","transport","httpAgent","httpsAgent","cancelToken","socketPath","responseEncoding"],s=["validateStatus"];function a(e,t){return l.isPlainObject(e)&&l.isPlainObject(t)?l.merge(e,t):l.isPlainObject(t)?l.merge({},t):l.isArray(t)?t.slice():t}function c(o){l.isUndefined(t[o])?l.isUndefined(e[o])||(r[o]=a(void 0,e[o])):r[o]=a(e[o],t[o])}l.forEach(o,(function(e){l.isUndefined(t[e])||(r[e]=a(void 0,t[e]))})),l.forEach(n,c),l.forEach(i,(function(o){l.isUndefined(t[o])?l.isUndefined(e[o])||(r[o]=a(void 0,e[o])):r[o]=a(void 0,t[o])})),l.forEach(s,(function(o){o in t?r[o]=a(e[o],t[o]):o in e&&(r[o]=a(void 0,e[o]))}));var u=o.concat(n).concat(i).concat(s),d=Object.keys(e).concat(Object.keys(t)).filter((function(e){return-1===u.indexOf(e)}));return l.forEach(d,c),r};function j(e){this.defaults=e,this.interceptors={request:new v,response:new v}}j.prototype.request=function(e){"string"==typeof e?(e=arguments[1]||{}).url=arguments[0]:e=e||{},(e=O(this.defaults,e)).method?e.method=e.method.toLowerCase():this.defaults.method?e.method=this.defaults.method.toLowerCase():e.method="get";var t=[N,void 0],r=Promise.resolve(e);for(this.interceptors.request.forEach((function(e){t.unshift(e.fulfilled,e.rejected)})),this.interceptors.response.forEach((function(e){t.push(e.fulfilled,e.rejected)}));t.length;)r=r.then(t.shift(),t.shift());return r},j.prototype.getUri=function(e){return e=O(this.defaults,e),y(e.url,e.params,e.paramsSerializer).replace(/^\?/,"")},l.forEach(["delete","get","head","options"],(function(e){j.prototype[e]=function(t,r){return this.request(O(r||{},{method:e,url:t,data:(r||{}).data}))}})),l.forEach(["post","put","patch"],(function(e){j.prototype[e]=function(t,r,o){return this.request(O(o||{},{method:e,url:t,data:r}))}}));var K=j;function L(e){this.message=e}L.prototype.toString=function(){return"Cancel"+(this.message?": "+this.message:"")},L.prototype.__CANCEL__=!0;var _=L;function V(e){if("function"!=typeof e)throw new TypeError("executor must be a function.");var t;this.promise=new Promise((function(e){t=e}));var r=this;e((function(e){r.reason||(r.reason=new _(e),t(r.reason))}))}V.prototype.throwIfRequested=function(){if(this.reason)throw this.reason},V.source=function(){var e;return{token:new V((function(t){e=t})),cancel:e}};var q=V;function D(e){var t=new K(e),r=i(K.prototype.request,t);return l.extend(r,K.prototype,t),l.extend(r,t),r}var F=D(B);F.Axios=K,F.create=function(e){return D(O(F.defaults,e))},F.Cancel=_,F.CancelToken=q,F.isCancel=w,F.all=function(e){return Promise.all(e)},F.spread=function(e){return function(t){return e.apply(null,t)}},F.isAxiosError=function(e){return"object"==typeof e&&!0===e.isAxiosError};var H=F,z=F;H.default=z;var M=H;class I extends Error{constructor(e,t="PythiaError",r=I){super(e),Object.setPrototypeOf(this,r.prototype),this.name=t}}class $ extends I{constructor(e,t,r){super(e,"PythiaClientError",$),this.code=t,this.httpStatus=r}}class J extends I{constructor(){super("Transformed password proof verification has failed","ProofVerificationFailedError",J)}}class X extends I{constructor(e,t){super(`Unexpected Breach-proof password version. Expected ${e}, got ${t}`,"UnexpectedBreachProofPasswordVersionError",X)}}class G{constructor(e,r,o){if(null==e)throw new Error("`accessTokenProvider` is required");this.accessTokenProvider=e,this.axios=M.create({baseURL:r||G.DEFAULT_URL}),this.virgilAgent=o||new t.VirgilAgent("pythia","1.0.2"),this.axios.interceptors.response.use(void 0,G.onBadResponse)}generateSeed(e,t){return r(this,void 0,void 0,(function*(){const r={blinded_password:e};t&&(r.brainkey_id=t);const o=yield this.accessTokenProvider.getToken({service:"pythia",operation:"seed"}),{data:{seed:n}}=yield this.axios.post("/pythia/v1/brainkey",r,{headers:G.getHeaders(this.virgilAgent,o)});return n}))}transformPassword(e){return r(this,void 0,void 0,(function*(){const t={blinded_password:e.blindedPassword,user_id:e.salt};"number"!=typeof e.version||Number.isNaN(e.version)||(t.version=e.version),"boolean"==typeof e.includeProof&&(t.include_proof=e.includeProof);const r=yield this.accessTokenProvider.getToken({service:"pythia",operation:"password"}),{data:{transformed_password:o,proof:n}}=yield this.axios.post("/pythia/v1/password",t,{headers:G.getHeaders(this.virgilAgent,r)}),i={transformedPassword:o};return t.include_proof&&(i.proof={valueC:n.value_c,valueU:n.value_u}),i}))}static getHeaders(e,t){return{Authorization:"Virgil "+t.toString(),"Virgil-Agent":e.value}}static onBadResponse(e){if(e.response){if(e.response.data){const t=e.response.data.message||e.response.statusText;throw new $(t,e.response.data.code,e.response.status)}throw new $(e.response.statusText,void 0,e.response.status)}throw new I("Something bad happened. Please try again later.")}}G.DEFAULT_URL="https://api.virgilsecurity.com";class Y{constructor(e){const t=null==(r=e)?[]:Array.isArray(r)?r:[r];var r;if(!t.length)throw new Error("`proofKeys` must not be empty");this.proofKeys=t.map(this.parseProofKey).sort(this.compareProofKeyVersions)}currentKey(){if(void 0===this.proofKeys[0])throw new Error("No proof key exists");return this.proofKeys[0]}proofKey(e){const t=this.proofKeys.find(t=>t.version===e);if(void 0===t)throw new Error(`Proof key of version ${e} does not exist`);return t}parseProofKey(e){const t=e.split(".");if(3!==t.length||"PK"!==t[0])throw new TypeError("`proofKey` format is invalid");return{version:Number(t[1]),key:t[2]}}compareProofKeyVersions(e,t){return t.version-e.version}}class W{constructor(e){this.crypto=e.crypto,this.proofKeys=e.proofKeys,this.pythiaClient=e.pythiaClient,this.pythiaCrypto=e.pythiaCrypto}verifyBreachProofPassword(e,t,o){return r(this,void 0,void 0,(function*(){const{blindedPassword:r,blindingSecret:n}=this.pythiaCrypto.blind(e),i=this.proofKeys.proofKey(t.version),{transformedPassword:s,proof:a}=yield this.pythiaClient.transformPassword({includeProof:o,blindedPassword:r.toString("base64"),salt:t.salt,version:t.version});if(o){if(!this.pythiaCrypto.verify({transformedPassword:s,blindedPassword:r,tweak:t.salt,transformationPublicKey:i.key,proofValueC:a.valueC,proofValueU:a.valueU}))throw new J}return((e,t)=>{if("string"!=typeof e||"string"!=typeof t)return!1;let r=e.length===t.length?0:1;r&&(t=e);for(let o=0,n=e.length;o<n;++o)r|=e.charCodeAt(o)^t.charCodeAt(o);return 0===r})(this.pythiaCrypto.deblind({transformedPassword:s,blindingSecret:n}).toString("base64"),t.deblindedPassword)}))}createBreachProofPassword(e){return r(this,void 0,void 0,(function*(){const t=this.crypto.getRandomBytes(W.SALT_BYTE_LENGTH),{blindedPassword:r,blindingSecret:o}=this.pythiaCrypto.blind(e),i=this.proofKeys.currentKey(),{transformedPassword:s,proof:a}=yield this.pythiaClient.transformPassword({blindedPassword:r.toString("base64"),salt:t.toString("base64"),version:i.version,includeProof:!0});if(!this.pythiaCrypto.verify({transformedPassword:s,blindedPassword:r,tweak:t,transformationPublicKey:i.key,proofValueC:a.valueC,proofValueU:a.valueU}))throw new J;const c=this.pythiaCrypto.deblind({transformedPassword:s,blindingSecret:o});return new n(t,c,i.version)}))}updateBreachProofPassword(e,t){const{prevVersion:r,nextVersion:o,token:i}=this.parseUpdateToken(e);if(t.version!==r)throw new X(r,t.version);const s=this.pythiaCrypto.updateDeblindedWithToken({deblindedPassword:t.deblindedPassword,updateToken:i});return new n(t.salt,s,o)}parseUpdateToken(e){const t=e.split(".");if(4!==t.length||"UT"!==t[0])throw new TypeError("`updateToken` format is invalid");return{prevVersion:Number(t[1]),nextVersion:Number(t[2]),token:t[3]}}}W.SALT_BYTE_LENGTH=32;e.BrainKey=o,e.BreachProofPassword=n,e.ProofKeys=Y,e.ProofVerificationFailedError=J,e.Pythia=W,e.PythiaClient=G,e.PythiaClientError=$,e.PythiaError=I,e.UnexpectedBreachProofPasswordVersionError=X,e.createBrainKey=e=>{const t=new G(e.accessTokenProvider,e.apiUrl);return e.virgilPythiaCrypto&&console&&console.warn&&console.warn("Option `virgilPythiaCrypto` is deprecated. Use `virgilBrainKeyCrypto` instead."),new o({pythiaClient:t,crypto:e.virgilCrypto,brainKeyCrypto:e.virgilBrainKeyCrypto||e.virgilPythiaCrypto,keyPairType:e.keyPairType})},e.createPythia=e=>{const t=new Y(e.proofKeys),r=new G(e.accessTokenProvider,e.apiUrl);return new W({proofKeys:t,pythiaClient:r,crypto:e.virgilCrypto,pythiaCrypto:e.virgilPythiaCrypto})},Object.defineProperty(e,"__esModule",{value:!0})}));
